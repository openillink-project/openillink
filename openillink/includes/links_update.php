<?php
// ***************************************************************************
// ***************************************************************************
// ***************************************************************************
// This file is part of OpenILLink software.
// Copyright (C) 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2015, 2016, 2017, 2018, 2020, 2024 CHUV.
// Original author(s): Pablo Iriarte <pablo@iriarte.ch>
// Other contributors are listed in the AUTHORS file at the top-level
// directory of this distribution.
// 
// OpenILLink is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
// 
// OpenILLink is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
// 
// You should have received a copy of the GNU General Public License
// along with OpenILLink.  If not, see <http://www.gnu.org/licenses/>.
// 
// ***************************************************************************
// ***************************************************************************
// ***************************************************************************
// links table : creation and update of records
// 
require_once ("config.php");
require_once ("authcookie.php");
require_once ("connexion.php");
require_once ("toolkit.php");

if (!empty($_COOKIE['illinkid'])){
    $id=!empty($_POST['id'])? (isValidInput($_POST['id'],11,'i',false)?$_POST['id']:'') : "";
    
    $validActionSet = array('new', 'update', 'delete', 'deleteok');
    $action = ((!empty($_GET['action'])) && isValidInput($_GET['action'],10,'s',false, $validActionSet)) ? $_GET['action'] : NULL;

    if (empty($action))
        $action = ((!empty($_POST['action'])) && isValidInput($_POST['action'],10,'s',false, $validActionSet)) ? $_POST['action'] : '';
    if (($monaut == "admin")||($monaut == "sadmin")){
        $mes="";
        $date=date("Y-m-d H:i:s");
        $linktitle = ((!empty($_POST['title'])) && isValidInput($_POST['title'],50,'s',false))?trim($_POST['title']):'';
        $linkurl = ((!empty($_POST['url'])) && isValidInput($_POST['url'],1000,'s',false))?trim($_POST['url']):'';
        $linksearch_issn = ((!empty($_POST['search_issn'])) && isValidInput($_POST['search_issn'],1,'i',false))?trim($_POST['search_issn']):0;
        $linksearch_isbn = ((!empty($_POST['search_isbn'])) && isValidInput($_POST['search_isbn'],1,'i',false))?trim($_POST['search_isbn']):0;
        $linksearch_ptitle = ((!empty($_POST['search_ptitle'])) && isValidInput($_POST['search_ptitle'],1,'i',false))?trim($_POST['search_ptitle']):0;
        $linksearch_btitle = ((!empty($_POST['search_btitle'])) && isValidInput($_POST['search_btitle'],1,'i',false))?trim($_POST['search_btitle']):0;
        $linksearch_atitle = ((!empty($_POST['search_atitle'])) && isValidInput($_POST['search_atitle'],1,'i',false))?trim($_POST['search_atitle']):0;
        $linkorder_ext = ((!empty($_POST['order_ext'])) && isValidInput($_POST['order_ext'],1,'i',false))?trim($_POST['order_ext']):0;
        $linkorder_form = ((!empty($_POST['order_form'])) && isValidInput($_POST['order_form'],1,'i',false))?trim($_POST['order_form']):0;
        $linkopenurl = ((!empty($_POST['openurl'])) && isValidInput($_POST['openurl'],1,'i',false))?trim($_POST['openurl']):0;
        $linklibrary = ((!empty($_POST['library'])) && isValidInput($_POST['library'],50,'s',false))?trim($_POST['library']):'';
        $linkactive = ((!empty($_POST['active'])) && isValidInput($_POST['active'],1,'i',false))?trim($_POST['active']):0;
        $linkordonnancement = ((!empty($_POST['active'])) && isValidInput($_POST['active'],3,'i',false))?$_POST['ordonnancement']:NULL;
        $linkurl_encode = ((!empty($_POST['url_encoded'])) && isValidInput($_POST['url_encoded'],1,'i',false))?trim($_POST['url_encoded']):0;
        $linkskip_words = ((!empty($_POST['skip_words'])) && isValidInput($_POST['skip_words'],1,'i',false))?trim($_POST['skip_words']):0;
        $linkskip_txt_after_mark = ((!empty($_POST['skip_txt_after_mark'])) && isValidInput($_POST['skip_txt_after_mark'],1,'i',false))?trim($_POST['skip_txt_after_mark']):0;
        if ($linksearch_issn != "1")
            $linksearch_issn = 0;
        if ($linksearch_isbn != "1")
            $linksearch_isbn = 0;
        if ($linksearch_ptitle != "1")
            $linksearch_ptitle = 0;
        if ($linksearch_btitle != "1")
            $linksearch_btitle = 0;
        if ($linksearch_atitle != "1")
            $linksearch_atitle = 0;
        if ($linkorder_ext != "1")
            $linkorder_ext = 0;
        if ($linkorder_form != "1")
            $linkorder_form = 0;
        if ($linkopenurl != "1")
            $linkopenurl = 0;
        if ($linkactive != "1")
            $linkactive = 0;
        if ($linkurl_encode != "1")
            $linkurl_encode = 0;
        if ($linkskip_words != "1")
            $linkskip_words = 0;
        if ($linkskip_txt_after_mark != "1")
            $linkskip_txt_after_mark = 0;
        if ($linkordonnancement < 1 || $linkordonnancement > 999)
            $linkordonnancement = 0;
        if (($action == "update")||($action == "new")){
            // Tester les champs obligatoires
            if ($linktitle == "")
                $mes = $mes . "<br/>".__("The link name is required");
            if ($linkurl == "")
                $mes = $mes . "<br/>".__("The URL is required");
            if ($mes != ""){
                require ("headeradmin.php");
                echo "<center><br/><b><font color=\"red\">\n";
                echo $mes."</b></font>\n";
                echo "<br /><br /><a href=\"javascript:history.back();\"><b>".__("Back to the form")."</a></b></center><br /><br /><br /><br />\n";
                require ("footer.php");
            }
            else{
                // Début de l'édition
                if ($action == "update"){
                    if ($id != ""){
                        require ("headeradmin.php");
                        $myhtmltitle = $configname[$lang] . " : ". format_string(__("edition of the record %id"), array('id' => htmlspecialchars($id)));
                        $reqid = "SELECT * FROM links WHERE id = ?";
                        $resultid = dbquery($reqid, array($id), 'i');
                        $nb = iimysqli_num_rows($resultid);
                        if ($nb == 1){
                            $enregid = iimysqli_result_fetch_array($resultid);
                            $query = 'UPDATE links SET links.title=?, '.
                            'links.url=?, links.search_issn=?, '.
                            'links.search_isbn=?, links.search_ptitle=?, '.
                            'links.search_btitle=?, links.search_atitle=?, '.
                            'links.order_ext=?, links.order_form=?, '.
                            'links.openurl=?, links.library=?, '.
                            'links.active=?, links.ordonnancement=?, '.
                            'links.url_encoded=?, links.skip_words=?, links.skip_txt_after_mark=? '.
                            'WHERE links.id=?';
                            $params = array($linktitle, $linkurl, $linksearch_issn, $linksearch_isbn, $linksearch_ptitle, $linksearch_btitle, $linksearch_atitle, $linkorder_ext, $linkorder_form, $linkopenurl, $linklibrary, $linkactive, $linkordonnancement, $linkurl_encode, $linkskip_words, $linkskip_txt_after_mark, $id);
                            $typeParam = 'ssiiiiiiiisiiiiii';
                            $resultupdate = dbquery($query, $params, $typeParam) or die("Error : ".mysqli_error(dbconnect()));
                            echo "<center><br/><b><font color=\"green\">\n";
                            echo format_string(__("The modification of the record %id_record has been successfully registered"),array('id_record' => htmlspecialchars($id)))."</b></font>\n";
                            echo "<br/><br/><br/><a href=\"list.php?table=links\">Retour à la liste de liens</a></center>\n";
                            require ("footer.php");
                        }
                        else{
                            echo "<center><br/><b><font color=\"red\">\n";
                            echo format_string(__("The change was not saved because the identifier of record %id_record was not found in the database."),array('id_record' => htmlspecialchars($id)))."</b></font>\n";
                            echo "<br /><br /><b>".__("Please restart your search or contact the database administrator")." : " . $configemail . "</b></center><br /><br /><br /><br />\n";
                            require ("footer.php");
                        }
                    }
                    else{
                        require ("headeradmin.php");
                        //require ("menurech.php");
                        echo "<center><br/><b><font color=\"red\">\n";
                        echo __("The modification was not saved because it lacks the identifier of the form")."</b></font>\n";
                        echo "<br /><br /><b>".__("Please retry your search")."</b></center><br /><br /><br /><br />\n";
                        require ("footer.php");
                    }
                }
				// Fin de l'édition
				// Début de la création
				if ($action == "new"){
					require ("headeradmin.php");
					$myhtmltitle = $configname[$lang] . " : nouveau lien ";
					$query = "INSERT INTO `links` (`title`, `url`, `search_issn`, `search_isbn`, `search_ptitle`, `search_btitle`, `search_atitle`, `order_ext`, `order_form`, `openurl`, `library`, `active`, `ordonnancement`, `url_encoded`, `skip_words`, `skip_txt_after_mark`) ".
					"VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
					$params = array($linktitle, $linkurl, $linksearch_issn, $linksearch_isbn, $linksearch_ptitle, $linksearch_btitle, $linksearch_atitle, $linkorder_ext, $linkorder_form, $linkopenurl,$linklibrary,$linkactive, $linkordonnancement, $linkurl_encode, $linkskip_words, $linkskip_txt_after_mark);
					$paramstypes = 'ssiiiiiiiissiiii';
					$id = dbquery($query, $params, $paramstypes) or die("Error : ".mysqli_error(dbconnect()));
					echo "<center><br/><b><font color=\"green\">\n";
					echo format_string(__("The new record %id_record has been successfully registered"),array('id_record' => htmlspecialchars($id)))."</b></font>\n";
					echo "<br/><br/><br/><a href=\"list.php?table=links\">".__("Back to the links list")."</a></center>\n";
					echo "</center>\n";
					echo "\n";
					require ("footer.php");
				}
			}
        }
        // Fin de la création
        // Début de la suppresion
        if ($action == "delete"){
            $id= ((!empty($_GET['id'])) && isValidInput($_GET['id'],11,'s',false)) ? $_GET['id'] : "";
            $myhtmltitle = $configname[$lang] . " : ".__("Confirmation for deleting a link");
            require ("headeradmin.php");
            echo "<center><br/><br/><br/><b><font color=\"red\">\n";
            echo format_string(__("Do you really want to delete the record %id_record ?"),array('id_record' => htmlspecialchars($id)))."</b></font>\n";
            echo "<form action=\"update.php\" method=\"POST\" enctype=\"x-www-form-encoded\" name=\"fiche\" id=\"fiche\">\n";
            echo "<input name=\"table\" type=\"hidden\" value=\"links\">\n";
            echo "<input name=\"id\" type=\"hidden\" value=\"".htmlspecialchars($id)."\">\n";
            echo "<input name=\"action\" type=\"hidden\" value=\"deleteok\">\n";
            echo "<br /><br />\n";
            echo "<input type=\"submit\" value=\"".format_string(__("Confirm the deletion of the record %id_record by clicking here"),array('id_record' => htmlspecialchars($id)))."\">\n";
            echo "</form>\n";
            echo "<br/><br/><br/><a href=\"list.php?table=links\">".__("Back to the links list")."</a></center>\n";
            echo "</center>\n";
            echo "\n";
            require ("footer.php");
        }
        if ($action == "deleteok"){
            $myhtmltitle = $configname[$lang] . " : ".__("Delete a library");
            require ("headeradmin.php");
            $query = "DELETE FROM links WHERE links.id = ?";
            $result = dbquery($query, array($id), 'i') or die("Error : ".mysqli_error(dbconnect()));
            echo "<center><br/><b><font color=\"green\">\n";
            echo format_string(__("The record %id_record has been successfully deleted"),array('id_record' => htmlspecialchars($id)))."</b></font>\n";
            echo "<br/><br/><br/><a href=\"list.php?table=links\">".__("Back to the libraries list")."</a></center>\n";
            echo "</center>\n";
            echo "\n";
            require ("footer.php");
        }
        // Fin de la suppresion
    }
    else{
        require ("header.php");
        echo "<center><br/><b><font color=\"red\">\n";
        echo __("Your rights are insufficient to edit this page")."</b></font></center><br /><br /><br /><br />\n";
        require ("footer.php");
    }
}
else{
    require ("header.php");
    require ("loginfail.php");
    require ("footer.php");
}
?>
